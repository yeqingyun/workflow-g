<#assign title="流程">
    <#include "/common/head.ftl">

        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north',border:false,minHeight:45," style="padding:5px 0px 5px 0px">
                <div style="padding:5px;height:85px;background:#fafafa;border:1px solid #ccc">
                    <table border="0" >
                        <tr>
                            <td align="right" style="white-space:nowrap">创建时间：</td>
                            <td>
                                <input id="startCreateTime-${rand}" type="text" class="easyui-my97" readonly="readonly" name="startCreateTime_d"
                                       data-options="dateFmt:'yyyy-MM-dd',width:130,required:false,maxDate:'#F{$dp.$D(\'endCreateTime-${rand}\')}'"/>
                            </td>
                            <td align="center" style="width:30px; white-space:nowrap;">-</td>
                            <td>
                                <input id="endCreateTime-${rand}" type="text" class="easyui-my97" readonly="readonly" name="endCreateTime_d"
                                       data-options="dateFmt:'yyyy-MM-dd',width:130,required:false,minDate:'#F{$dp.$D(\'startCreateTime-${rand}\')}'"/>
                            </td>
                            <td align="right" style="white-space:nowrap; padding-left:12px;">流程实例编号：</td>
                            <td>
                                <input id="proInstId-${rand}" style="width:148px;" class="easyui-textbox" type="text" name="proInstId" data-options=""></input>
                            </td>
                            <td  align="left" style="white-space:nowrap;padding-left:12px;">
                                <a href="javascript:void(0)" id="search_btn-${rand}" class="easyui-linkbutton" iconCls="icon-search">查询</a>
                                <a href="javascript:void(0)" id="reset_btn-${rand}" class="easyui-linkbutton" iconCls="icon-reload">重置</a>
                            </td>
                        </tr>
                        <tr>
                            <td align="right" style="white-space:nowrap">计划完成时间：</td>
                            <td>
                                <input id="startDueTime-${rand}" type="text" class="easyui-my97" readonly="readonly" name="startDueTime_d"
                                       data-options="dateFmt:'yyyy-MM-dd',width:130,required:false,maxDate:'#F{$dp.$D(\'endDueTime-${rand}\')}'"/>
                            </td>
                            <td align="center" style="width:30px; white-space:nowrap;">-</td>
                            <td>
                                <input id="endDueTime-${rand}" type="text" class="easyui-my97" readonly="readonly" name="endDueTime_d"
                                       data-options="dateFmt:'yyyy-MM-dd',width:130,required:false,minDate:'#F{$dp.$D(\'startDueTime-${rand}\')}'"/>
                            </td>
                            <td align="right" style="white-space:nowrap">流程名称：</td>
                            <td>
                                <input id="processTree-${rand}" class="easyui-combotree" data-options="panelHeight:300,panelWidth:230,lines:true,url:'menus.json',onClick:proTreeNodeClick${rand}" style="width:154px;"/>
                                <input id="processDefId-${rand}" type="hidden" value=""/>
                                <input id="categoryId-${rand}" type="hidden" value=""/>
                            </td>
                        </tr>
                        <tr>
                            <td align="left" style="white-space:nowrap; padding-left:12px;">任务名称：</td>
                            <td>
                                <input id="name-${rand}" style="width:148px;" class="easyui-textbox" type="text" name="name" data-options=""/>
                            </td>

                            <td align="right" style="white-space:nowrap">实例名称：</td>
                            <td>
                                <input id="proInstName-${rand}" style="width:148px;" class="easyui-textbox" type="text" name="proInstName" data-options=""></input>
                            </td>
                        </tr>
                    </table>
                </div>


            </div>

            <div data-options="region:'center',border:false" style="padding:0px 0px 0px 0px;">
                <div id="personalTaskGrid-${rand}"></div>
            </div>
        </div>

        <div id="win-${rand}" class="easyui-dialog" title="Dialog" style="overflow:visible;width:1030px;height:500px;padding:0px 10px 10px 10px"
             data-options="
	   modal:true,
	   closed:true,
	   maximizable:true,
	   cache: false,
	   onMaximize:winOnMax${rand},
	   onRestore:winOnRestore${rand},
	   onClose:winOnClose${rand},
	   resizable:true">
            <div id="tab-${rand}">
                <div title="处理任务" style="overflow:auto;padding:0px;">
                    <div id="formOperatePanel-${rand}" class="easyui-panel" data-options="width:975"
                         style="padding:5px;z-index:auto;position:fixed;">
                        <a href="javascript:void(0)" id="submitBtn-${rand}" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save'">完成</a>
                        <a href="javascript:void(0)" id="uploadBtn-${rand}" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-back'">上传附件</a>
                        <a href="javascript:void(0)" id="turntodoTask-${rand}" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-turntodo'">转办</a>
                    </div>
                    <div id="loadFormPanel-${rand}" data-options="fit:true,width:975" style="overflow:yes;padding:50px 0px 0px 0px;">
                    </div>
                </div>
                <div title="查看历史" style="overflow:auto;padding:5px;">
                </div>
            </div>
        </div>

        <div id="upload-${rand}" class="easyui-dialog" title="上传附件"
             data-options="iconCls:'icon-save',resizable:true,width:708,height:544,modal:true,closed:true,
        	buttons: [{
                    text:'完成',
                    iconCls:'icon-ok',
                    handler: closeUploadDiag${rand}
                }]
        ">
            <div id="uploader${rand}" class="fileUploader">
                <div id="fileList${rand}" class="uploader-list"></div>
                <table style="width: 100%;text-align: center;padding-top: 20px;">
                    <tr>
                        <td align="right"><div id="filePicker${rand}">选择文件</div></td>
                        <td align="left"><a id="ctlBtn${rand}" href="javascript:void(0)" class='btn'>开始上传</a></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- trun to do win -->
        <div id="truntodoWin-${rand}" class="easyui-dialog" title="转办" style="width:650px;height:250px;padding:5px"
             data-options="
	   modal:true,
	   closed:true,
	   maximizable:false,
	   cache: false,
	   resizable:true,
       buttons: [{
       		text:'确定',
            iconCls:'icon-ok',
           	handler:truntodoWinSubmit${rand}
     	},{
           text:'关闭',
           iconCls:'icon-cancel',
           handler:truntodoWinClose${rand}
       }]">
            <div>
                <form id="turntodoForm${rand}" method="post" enctype='multipart/form-data'>
                    <table id="turntodoFormTable" class="formtable" cellspacing="1" cellpadding="0">
                        <tr>
                            <td class="formtable_td_key">任务接收人：</td>
                            <td class="formtable_td_value">
                                <input id="accepter${rand}" type="hidden" value="" name="accepter"/>
                                <input id="accepterName${rand}" class="easyui-validatebox" readonly="readonly" name="accepterName" data-options="required:true">
                                <a id="openOrgWinBtn${rand}" href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'icon-search'">选择</a>
                            </td>
                        </tr>
                        <tr>
                            <td class="formtable_td_key">转办原因：</td>
                            <td class="formtable_td_value">
		  	  			<textarea name="turntodoReason" class="formtable_remark easyui-validatebox"
                                  style="width: 450px; height: 100px"></textarea>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>

        <!-- select account win -->
        <div id="orgWin-${rand}" class="easyui-dialog" title="用户选择窗口"
             style="width: 1000px; height: 500px; padding: 5px"
             data-options="modal:true, closed:true,iconCls:'icon-process',
				buttons: [{
		                  text:'完成',
		                  iconCls:'icon-ok',
		                  handler: selectUserEnd
		              },{
		                  text:'关闭',
		                  iconCls:'icon-cancel',
		                  handler: closeSelectUserWin
		              }]">
            <div class="easyui-layout" data-options="fit:true">
                <div data-options="region:'north',border:false,minHeight:30," style="padding:5px 0px 5px 0px">
                    <div style="padding:5px;height:30px;background:#fafafa;border:1px solid #ccc">
                        <table border="0" >
                            <tr>
                                <td align="right" style="white-space:nowrap;padding-left:12px;" >用户编号：</td>
                                <td width="160px">
                                    <input id="userAccount-${rand}" style="width:154px;" class="easyui-validatebox" type="text" name="account" data-options=""/>
                                </td>
                                <td align="right" style="white-space:nowrap; padding-left:12px;">用户姓名：</td>
                                <td width="160px">
                                    <input id="userName-${rand}" style="width:154px;" class="easyui-validatebox" type="text" name="name" data-options=""/>
                                </td>
                                <td  align="left" style="white-space:nowrap;padding-left:12px;">
                                    <a href="javascript:void(0)" id="user_search_btn-${rand}" class="easyui-linkbutton" iconCls="icon-search">查询</a>
                                    <a href="javascript:void(0)" id="user_reset_btn-${rand}" class="easyui-linkbutton" iconCls="icon-reload">重置</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div data-options="region:'center',border:false" style="padding:0px 0px 0px 0px;">
                    <div id="userGrid-${rand}"></div>
                </div>
            </div>
        </div>

        <div id="batchHandleProcessWin-${rand}" class="easyui-dialog" title="批量审批" style="width:1030px;height:400px;padding:5px"
             data-options="
	   modal:true,
	   closed:true,
	   maximizable:false,
	   cache: false,
	   resizable:true,
       buttons: [{
       		text:'确定',
            iconCls:'icon-ok',
            handler: batchHandleWinSubmit${rand}
     	},{
           text:'关闭',
           iconCls:'icon-cancel',
           handler: batchHandleWinCancel${rand}
       }]">
        </div>

        <script type="text/javascript">
            $('#personalTaskGrid-${rand}').datagrid({
                fitColumns:true,
                url:'workspace/personalTask.json',
                columns:[[
                    {field:'id',title:'任务编号',checkbox:true,hidden:false,width:80},
                    {field:'processInstanceId',title:'流程实例编号',width:160,align:'center'},
                    {field:'processInstanceName',title:'实例名称',width:150,align:'center'},
                    {field:'processDefName',title:'流程名称',width:130,align:'center'},
                    {field:'processDefinitionId',title:'流程定义',hidden:true,width:150},
                    {field:'proStartUserId',title:'流程发起人工号',hidden:true,width:150},
                    {field:'proStartUserName',title:'流程发起人',width:100,align:'center'},
                    {field:'categoryName',title:'流程所属部门',width:120,align:'center'},
                    {field:'name',title:'任务名称',width:120,align:'center'},
                    {field:'suspensionState',title:'状态',width:80,align:'center',
                        formatter: function(value,row,index){
                            if (value == 1){
                                return '<span style="color:#EE0000">待办理</span>';
                            } else if(value == 2){
                                return '<span style="color:#B03060">已暂停</span>';
                            }
                        }
                    },
                    {field:'assignee',title:'处理人',hidden:true,width:100},
                    {field:'taskDefinitionKey',title:'TaskKey',hidden:true,width:100},
                    {field:'createTime',title:'创建时间',width:130,align:'center'},
                    {field:'dueDate',title:'计划完成时间',width:130,align:'center'}
                ]],
                nowrap: true,
                fit : true,
                border : true,
                pagination:true,
                pageNumber : 1,
                pageSize : 20,
                rownumbers:true,
                singleSelect:false,
                toolbar: [{
                    text : '办理',
                    iconCls: 'icon-handle',
                    handler: handleProcess${rand}
            },'-',{
                text:'批量办理',
                iconCls: 'icon-batch_handle',
                handler: batchHandleProcess${rand}

            },'-',{
                text:'转办',
                iconCls: 'icon-turntodo',
                handler: turntodoTask${rand}

            },'-',{
                text:'签收',
                iconCls: 'icon-joinprocess',
                handler: signTask${rand}
            },'-',{
                text:'退回任务',
                iconCls: 'icon-retrieve',
                handler: returnTask${rand}
            }],
            onDblClickRow:function(index, row){
                dbHandleProcess${rand}(row);
            }
            });


            $('#tab-${rand}').tabs({
                border:false,
                fit:true,
                onSelect:function(title){
                    if (title == '查看历史') {
                        var tab = $('#tab-${rand}').tabs('getSelected');
                        $('#tab-${rand}').tabs('update', {
                            tab: tab,
                            options: {
                                href: 'workspace/personalTaskHistory.html?processInstanceId=' + processInstanceId
                            }
                        });
                    }
                }
            });


            var taskId = null;
            var taskDefKey = null;
            var processInstanceId = null;
            var assignee=null;
            //处理任务
            function handleProcess${rand}(){
                var rowArr = $('#personalTaskGrid-${rand}').datagrid('getSelections');
                var row = null;
                if (rowArr != null && rowArr.length > 0) {
                    if (rowArr.length == 1){
                        row = rowArr[0];
                        if(row.assignee == null){
                            $.messager.alert('信息提示','请先签收任务再处理该任务!','info');
                            return;
                        } else {
                            $('#win-${rand}').dialog('setTitle', '办理任务[' + getTabTitle() + ']');
                            //$('#win-${rand}').dialog('refresh', 'sysprocess/task/form.html?taskId=' + row.id);
                            taskId = row.id;
                            taskDefKey = row.taskDefinitionKey;
                            processInstanceId = row.processInstanceId;
                            $('#win-${rand}').dialog('open');

                            //初始化表单
                            $('#loadFormPanel-${rand}').panel({
                                border:false,
                                href:'sysprocess/task/form.html?taskId=' + taskId
                            });
                            //initStartForm${rand}(getTabTitle(), 'myflow/task/' + row.id + '.json', "myflow/complete/" + row.id + ".json");

                            clearFormInitBtn${rand}();
                        }
                    } else {
                        $.messager.show({
                            title: '信息提示',
                            msg: "请选择一条记录！"
                        });
                    }
                } else {
                    $.messager.show({
                        title: '信息提示',
                        msg: "请选择记录！"
                    });
                }

            }
            //双击处理
            function dbHandleProcess${rand}(row){
                $('#win-${rand}').dialog('setTitle', '办理任务[' + getTabTitle() + ']');
                taskId = row.id;
                assignee=row.assignee;
                taskDefKey = row.taskDefinitionKey;
                processInstanceId = row.processInstanceId;
                $('#win-${rand}').dialog('open');
                //初始化表单
                $('#loadFormPanel-${rand}').panel({
                    border:false,
                    href:'sysprocess/task/form.html?taskId=' + taskId
                });

                clearFormInitBtn${rand}();

            }

            function clearFormInitBtn${rand}(){
                var item = $('#fileList${rand}').datagrid('getRows');
                if (item) {
                    for (var i = item.length - 1; i >= 0; i--) {
                        var index = $('#fileList${rand}').datagrid('getRowIndex', item[i]);
                        GnifFileUpload.removeFileFromQueue(uploader${rand},item[i]['fileId']);
                        $('#fileList${rand}').datagrid('deleteRow', index);
                    }
                }

                //清空file数据
                if($('#attchFileGrid-${rand}').attr("id")){
                    var item = $('#attchFileGrid-${rand}').datagrid('getRows');
                    if (item) {
                        for (var i = item.length - 1; i >= 0; i--) {
                            var index = $('#attchFileGrid-${rand}').datagrid('getRowIndex', item[i]);
                            $('#attchFileGrid-${rand}').datagrid('deleteRow', index);
                        }
                    }
                }

                GnifFileUpload.btnInit("ctlBtn${rand}",uploader${rand});
            }


            function commitForm${rand}() {
                $.messager.progress();
                var div = $('#win-${rand}');
                var operateForm = div.find("form[id^='"+ taskDefKey +"Form']");
                operateForm.form('submit', {
                    url: 'sysprocess/complete/'+taskId+".html",
                    onSubmit: function(param) {
                        var validateResult = $(this).form('enableValidation').form('validate');
                        if (validateResult) {
                            if ($('#attchFileGrid-${rand}').length > 0) {
                                var rows = $('#attchFileGrid-${rand}').datagrid('getRows');
                                $.each(rows, function(i, d){
                                    param['attch_' + i] = d.fileNo + "_" + d.fileName
                                });
                            }
                        } else {
                            $.messager.progress('close');
                            return false;
                        }
                    },
                    success: function(data) {
                        $.messager.progress('close');
                        var data = JSON.parse(data);
                    	if(data.attributes && data.attributes.close == false){
                    	}else{
	                        $('#win-${rand}').dialog('close');
                    	}
                        $.messager.show({
                            title: '信息提示',
                            msg: data.msg
                        });
                        //重新加载
                        $('#personalTaskGrid-${rand}').datagrid('reload');




                        //改变上传附件的临时状态
                        GnifFileUpload.changeTmp('attchFileGrid-${rand}','${oss_server}','${oss_code}',0);




                    }
                });
            }

            //提交
            $('#submitBtn-${rand}').bind('click', function(){
                commitForm${rand}();
            });

            //上传
            $('#uploadBtn-${rand}').bind('click', function(){
                addAttache${rand}();
            });

            //转办
            $('#turntodoTask-${rand}').bind('click',function(){
                $('#truntodoWin-${rand}').dialog('open');
            });

            function signTask${rand}(){
                var rowArr = $('#personalTaskGrid-${rand}').datagrid('getSelections');
                var row = null;
                if (rowArr != null && rowArr.length > 0) {
                    if (rowArr.length == 1){
                        row = rowArr[0];
                        if (row.assignee == null){
                            $.messager.confirm('提示信息','您确定要签收任务吗?',function(r){
                                if (r){
                                    $.messager.progress();
                                    $.post('workspace/signTask.html',{taskId:row.id},function(result){
                                        $.messager.progress('close');
                                        $.messager.show({
                                            title: '信息提示', msg: result.msg
                                        });
                                        if (result.success){
                                            $('#personalTaskGrid-${rand}').datagrid('reload');
                                        }
                                    },'json');
                                }
                            });
                        } else {
                            $.messager.alert('信息提示','该任务已经分配,不需要签收!','info');
                        }
                    } else {
                        $.messager.show({
                            title: '信息提示',
                            msg: "请选择一条记录！"
                        });
                    }
                } else {
                    $.messager.show({
                        title: '信息提示',
                        msg: "请选择记录！"
                    });
                }
            }

            //turn to do task
            function turntodoTask${rand}(){
                var rowArr = $('#personalTaskGrid-${rand}').datagrid('getSelections');
                var row = null;
                if (rowArr != null && rowArr.length > 0) {
                    if (rowArr.length == 1) {
                        row = rowArr[0];
                        assignee=row.assignee;
                        if(assignee == null){
                            $.messager.alert('信息提示','请先签收任务再处理该任务!','info');
                            return;
                        } else {
                            taskId = row.id;
                            taskDefKey = row.taskDefinitionKey;
                            processInstanceId = row.processInstanceId;
                            $('#truntodoWin-${rand}').dialog('open');
                        }
                    } else {
                        $.messager.show({
                            title: '信息提示',
                            msg: "请选择一条记录！"
                        });
                    }
                } else {
                    $.messager.show({
                        title: '信息提示',
                        msg: "请选择记录！"
                    });
                }
            }

            function winOnMax${rand}(){
                $('#loadFormPanel-${rand}').panel('resize',{
                    width: document.body.clientWidth - 35
                });
                $('#formOperatePanel-${rand}').panel('resize',{
                    width: document.body.clientWidth - 35,
                    height: 35
                });
                $('#attchFileGrid-${rand}').datagrid('resize',{
                    width: document.body.clientWidth - 35
                });

                //流程图
                $('#viewTaskProcessImage').panel('resize',{
                    width: document.body.clientWidth - 65
                });
                //任务列表
                $('#viewTaskHisTaskGrid').datagrid('resize',{
                    width: document.body.clientWidth - 65
                });
                //历史表单
                $('#viewTaskHisFormContent').panel('resize',{
                    width: document.body.clientWidth - 65
                });
                //附件
                $('#viewTaskHisAttachmentGrid').datagrid('resize',{
                    width: document.body.clientWidth - 65
                });
            }

            function winOnRestore${rand}(){
                $('#loadFormPanel-${rand}').panel('resize',{
                    width: 975
                });

                $('#formOperatePanel-${rand}').panel('resize',{
                    width: 975,
                    height: 35
                });

                $('#attchFileGrid-${rand}').datagrid('resize',{
                    width: 975
                });

                //流程图
                $('#viewTaskProcessImage').panel('resize',{
                    width: 965
                });
                //任务列表
                $('#viewTaskHisTaskGrid').datagrid('resize',{
                    width: 965
                });
                //历史表单
                $('#viewTaskHisFormContent').panel('resize',{
                    width: 965
                });
                //附件
                $('#viewTaskHisAttachmentGrid').datagrid('resize',{
                    width: 965
                });
            }

            function winOnClose${rand}(){
                //$('#win-${rand}').dialog('destroy');
            }

            function addAttache${rand}(){
                $('#upload-${rand}').dialog('open');
            }

            function delAttch${rand}(fileNo,fileDivId){
                GnifFileUpload.deleteFile("${oss_code}",fileNo,deleteAttachGrid${rand}(fileDivId));
            }
            function deleteAttachGrid${rand}(fileDivId){
                //删除表单file

                var item = $('#attchFileGrid-${rand}').datagrid('getRows');
                if (item) {
                    for (var i = item.length - 1; i >= 0; i--) {
                        if(item[i]['fileDivId'] == fileDivId) {
                            var index = $('#attchFileGrid-${rand}').datagrid('getRowIndex',item[i]);
                            $('#attchFileGrid-${rand}').datagrid('deleteRow', index);
                        }

                    }
                }


                var grid = $("#fileList${rand}").datagrid('getRows');
                if (grid) {
                    for (var i = grid.length - 1; i >= 0; i--) {
                        if(grid[i]['fileId'] == fileDivId) {
                            var idx = $("#fileList${rand}").datagrid('getRowIndex',grid[i]);
                            $("#fileList${rand}").datagrid('deleteRow', idx);
                        }

                    }
                }


                GnifFileUpload.removeFileFromQueue(uploader${rand},fileDivId);

                //删除控件中的文件显示
                //$("#fileList${rand}").datagrid('deleteRow', delindex);
            }

            //关闭上传文件框
            function closeUploadDiag${rand}(){
                $('#upload-${rand}').dialog('close');
            }


            function proTreeNodeClick${rand}(node){
                var processTree = $('#processTree-${rand}');
                var proDefId = $('#processDefId-${rand}');
                var categoryId = $('#categoryId-${rand}');

                //清空
                proDefId.val('');
                categoryId.val('');

                if (node.id == null) {
                    var defArr = node.attributes.processDefId.split(":");
                    proDefId.val(defArr[0]);
                } else {
                    categoryId.val(node.id);
                }
                return true;
            }

            //按钮绑定事件
            $('#search_btn-${rand}').bind('click', function(){
                var startCreateTime = $('#startCreateTime-${rand}').val();
                var endCreateTime = $('#endCreateTime-${rand}').val();
                var proInstId = $('#proInstId-${rand}').val();
                var proInstName = $('#proInstName-${rand}').val();
                var startDueTime = $('#startDueTime-${rand}').val();
                var endDueTime = $('#endDueTime-${rand}').val();
                var processDefId = $('#processDefId-${rand}').val();
                var categoryId = $('#categoryId-${rand}').val();
                var name=$('#name-${rand}').val();
                $('#personalTaskGrid-${rand}').datagrid('reload',
                    {
                        startCreateTime_d:startCreateTime,
                        endCreateTime_d:endCreateTime,
                        proInstId:proInstId,
                        startDueTime_d:startDueTime,
                        endDueTime_d:endDueTime,
                        processDefId:processDefId,
                        processInstanceName:proInstName,
                        categoryId:categoryId,
                        name:name
                    });
            });

            $('#reset_btn-${rand}').bind('click', function(){
                $('#startCreateTime-${rand}').val('');
                $('#endCreateTime-${rand}').val('');
                $('#proInstId-${rand}').val('');
                $('#startDueTime-${rand}').val('');
                $('#endDueTime-${rand}').val('');
                $('#proInstName-${rand}').val('');
                $('#processTree-${rand}').combotree('clear');
                $('#name-${rand}').val('');
                //特殊处理
                $('#processDefId-${rand}').val('');
                $('#categoryId-${rand}').val('');
            });

            //弹出窗口
            $('#openOrgWinBtn${rand}').bind('click', function(){
                //重新加载用户数据
                $('#userGrid-${rand}').datagrid('reload',
                    {
                        taskId:taskId
                    });
                $('#orgWin-${rand}').dialog('open');
            });

            //转办提交
            function truntodoWinSubmit${rand}(){
                //var row = $('#personalTaskGrid-${rand}').datagrid('getSelected');
                //if (row){
                if (assignee != null){
                    $.messager.progress();
                    $('#turntodoForm${rand}').form('submit', {
                        url: 'workspace/turntodoTask/'+taskId+".html",
                        onSubmit: function(param) {
                            var validateResult = $(this).form('enableValidation').form('validate');
                            if (!validateResult) {
                                $.messager.progress('close');
                                return false;
                            }
                        },
                        success: function(data) {
                            $.messager.progress('close');
                            var data = JSON.parse(data);
                            $('#truntodoWin-${rand}').dialog('close');
                            $.messager.show({
                                title: '信息提示',
                                msg: data.msg
                            });
                            $('#win-${rand}').dialog('close');
                            //重新加载
                            $('#personalTaskGrid-${rand}').datagrid('reload');
                        }
                    });
                } else {
                    $.messager.alert('信息提示','该任务未签收,请签收任务后在进行转办操作!','info');
                }
                /*} else {
                 $.messager.show({
                 title: '信息提示',
                 msg: "请选择记录！"
                 });
                 }*/
            }
            //转办关闭
            function truntodoWinClose${rand}(){
                $('#truntodoWin-${rand}').dialog('close');
            }

            //init org win
            $(function(){
                $('#userGrid-${rand}').datagrid({
                    fitColumns:true,
                    url:'hrFlow/queryUserByOrgId.json',
                    queryParams: {
                        taskId: taskId
                    },
                    columns:[[
                        {field:'id',hidden:true, checkbox:false},
                        {field:'account',title:'帐号',width:150},
                        {field:'name',title:'姓名',width:150},
                        {field:'orgId',title:'部门ID',hidden:true, width:150},
                        {field:'orgName',title:'部门名称',width:150}
                    ]],
                    nowrap: true,
                    fit : true,
                    border : true,
                    pagination:true,
                    pageNumber : 1,
                    pageSize : 20,
                    rownumbers:true,
                    singleSelect:true
                });
            });

            //按钮绑定事件
            $('#user_search_btn-${rand}').bind('click', function(){
                var account = $('#userAccount-${rand}').val();
                var name = $('#userName-${rand}').val();

                $('#userGrid-${rand}').datagrid('reload',
                    {
                        account:account,
                        name:name,
                        taskId:taskId
                    });
            });

            $('#user_reset_btn-${rand}').bind('click', function(){
                $('#userAccount-${rand}').val('');
                $('#userName-${rand}').val('');
            });

            //选择用户完成事件
            function selectUserEnd(){
                var row = $('#userGrid-${rand}').datagrid('getSelected');
                if (row) {
                    $('#accepter${rand}').val(row.account);
                    $('#accepterName${rand}').val(row.name);

                    $('#accepterName${rand}').validatebox('validate');

                    $('#orgWin-${rand}').dialog('close');
                } else {
                    $.messager.alert('信息提示','请从人员列表中选择一条记录!','warning');
                }
            }

            function  closeSelectUserWin(){
                $('#orgWin-${rand}').dialog('close');
            }

            //batch handle
            function batchHandleProcess${rand}(){
                var rowArr = $('#personalTaskGrid-${rand}').datagrid('getSelections');
                var row = null;
                var result = true;
                if (rowArr != null && rowArr.length > 0) {
                    var processDefName = rowArr[0].processDefName;
                    var temp_TaskDefKey = rowArr[0].taskDefinitionKey;

                    var proName = rowArr[0].processDefName;
                    var taskName = rowArr[0].name;
                    for (var i=0;i<rowArr.length;i++) {
                        if (rowArr[i].processDefName != processDefName ||
                            rowArr[i].taskDefinitionKey != temp_TaskDefKey) {
                            result = false;
                        }
                    }
                    if (result) {
                        taskId = rowArr[0].id;
                        taskDefKey = rowArr[0].taskDefinitionKey;
                        processInstanceId = rowArr[0].processInstanceId;

                        $('#batchHandleProcessWin-${rand}').dialog('setTitle', '批量办理任务[' + proName + '-' + taskName + ']');
                        $('#batchHandleProcessWin-${rand}').dialog('open');
                        $('#batchHandleProcessWin-${rand}').dialog('refresh','sysprocess/task/batchform.html?taskId=' + taskId);
                    } else {
                        $.messager.alert('信息提示','同一类流程的任务才能批量处理!','warning');
                    }
                } else {
                    $.messager.show({
                        title: '信息提示',
                        msg: "请选择记录！"
                    });
                }
            }
            //submit
            function batchHandleWinSubmit${rand}(){
                $.messager.progress();
                var div = $('#batchHandleProcessWin-${rand}');
                var operateForm = div.find("form[id^='"+ taskDefKey +"Form']");
                operateForm.form('submit', {
                    url: 'sysprocess/batchCompleteTask.html',
                    onSubmit: function(param) {
                        var validateResult = $(this).form('enableValidation').form('validate');
                        if (validateResult) {
                            //获取多选的任务ID
                            var rowArr = $('#personalTaskGrid-${rand}').datagrid('getSelections');
                            var taskIds = "";
                            for (var i=0;i<rowArr.length;i++) {
                                taskIds += rowArr[i].id + ",";
                            }
                            param['taskIds'] = taskIds
                        } else {
                            $.messager.progress('close');
                            return false;
                        }
                    },
                    success: function(data) {
                        $.messager.progress('close');
                        var data = JSON.parse(data);
                        $('#batchHandleProcessWin-${rand}').dialog('close');
                        $.messager.show({
                            title: '信息提示',
                            msg: data.msg
                        });
                        //重新加载
                        $('#personalTaskGrid-${rand}').datagrid('reload');
                    }
                });
            }
            //cancel
            function batchHandleWinCancel${rand}(){
                $('#batchHandleProcessWin-${rand}').dialog('close');
            }

            function returnTask${rand}(){
                var row = $('#personalTaskGrid-${rand}').datagrid('getSelected');
                if (row){
                    $.messager.confirm('提示信息','您确定要退回任务吗?',function(r){
                        if (r){
                            $.post('workspace/returnTask.html',{processInstanceId:row.processInstanceId},function(result){
                                $.messager.alert('信息提示', result.msg,'warning');
                                if (result.success){
                                    $('#personalTaskGrid-${rand}').datagrid('reload');
                                }
                            },'json');
                        }
                    });
                } else {
                    $.messager.show({
                        title: '信息提示',
                        msg: "请选择记录！"
                    });
                }
            }


            var uploader${rand} = GnifFileUpload.init(
                "js/fileupload/Uploader.swf",
                "${oss_server}",
                "filePicker${rand}",
                "fileList${rand}",
                "ctlBtn${rand}",
                "uploader${rand}",
                true,
                "${oss_code}",
                uploadSuccess${rand},
                "attchFileGrid-${rand}",
                1
            );

            //上传回调
            function uploadSuccess${rand}(response,file) {

                if($('#attchFileGrid-${rand}').length <= 0){
                    var $table= $("#" + taskDefKey + "Form");
                    var div = '<br/><div id="attchFileGrid-${rand}"></div>';
                    $table.after(div);

                    $('#attchFileGrid-${rand}').datagrid({
                        columns:[[
                            {field:'fileNo',title:'文件编号',width:100},
                            {field:'fileName',title:'文件名',width:120},
                            {field:'fileSize',title:'文件大小',width:120},
                            {field:'param',title:'下载参数',width:0,hidden:'true'},
                            {field:'fileDivId',title:'文件节点id',width:0,hidden:'true'},
                            {field:'operate',title:'操作',width:120,
                                formatter: function(value,row,index){
                                    var returnStr = "<a href='${file_download_url}"+ row.param +"'>下载</a>"
                                        + "&nbsp;&nbsp;<a href='javascript:void(0)' onclick=delAttch${rand}("+row.fileNo+",'"+row.fileDivId+"');>删除</a>"
                                    return returnStr;
                                }
                            }
                        ]],
                        title:'附件列表',
                        fitColumns:true,
                        rownumbers:true,
                        nowrap: true,
                        border : true
                    });
                }



                var fileAttr = response.attributes;
                var signatureAttr = JSON.parse(GnifFileUpload.sendRequest("./getSignatureAndPolicy.json?info=",encodeURIComponent("0\\n0\\n"+fileAttr.fileNo)));
                $('#attchFilePanel-${rand}').panel('open');
                $('#attchFileGrid-${rand}').datagrid('appendRow',{
                    fileNo: fileAttr.fileNo,
                    fileName: fileAttr.fileName,
                    fileSize: fileAttr.fileSize.formatSize(),
                    param: "?code=${oss_code}&policy="+signatureAttr.policy+"&signature="+signatureAttr.signature,
                    fileDivId: file.id
                });
            }


        </script>
        <#include "/common/foot.ftl">
